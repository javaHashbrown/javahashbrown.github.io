{"data":{"markdownRemark":{"id":"4e5545e0-d6ac-5a37-9b99-fe184879c4d8","excerpt":"问题出现 APP 某个页面加载时访问了 2 个 API，两者的返回数据都分别有 type 字段，用于区分对应的数据列表中项目的类别，前端界面再根据类别渲染不同的界面 这个时候问题出现了，第一个 API 一切正常，第二个 API 返回列表本应全是 type=…","html":"<h4 id=\"问题出现\"><a href=\"#%E9%97%AE%E9%A2%98%E5%87%BA%E7%8E%B0\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>问题出现</h4>\n<blockquote>\n<p>APP 某个页面加载时访问了 2 个 API，两者的返回数据都分别有<code>type</code>字段，用于区分对应的数据列表中项目的类别，前端界面再根据类别渲染不同的界面</p>\n</blockquote>\n<p>这个时候问题出现了，第一个 API 一切正常，第二个 API 返回列表本应全是<code>type=1</code>的数据类型，但是每次返回的第一条数据都是<code>type=2</code></p>\n<h4 id=\"调试\"><a href=\"#%E8%B0%83%E8%AF%95\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>调试</h4>\n<ol>\n<li>\n<p>很自然打开<code>chrome devTool</code>，打印并查看后台返回数据，嗯，返回的数据<code>type=2</code>，看来是后台问题可能性较大</p>\n</li>\n<li>\n<p>再次确认，用<code>postman</code>请求一次接口看看返回数据，咦，怎么返回数据又对了，<code>type=1</code>，反复试了几次，还是对的</p>\n</li>\n<li>\n<p>换了一个 API 测试工具，结果和 2 一样，看样子应该是前端的问题了，而且应该是网络层的问题，而网络层是基于 axios 封装的，也就是说 axios 有问题？</p>\n</li>\n<li>\n<p>还是觉得需要首先排除后台原因，于是让后台同事打印出接口返回数据，对比之后发现和 API 工具结果一致，基本排除后端责任</p>\n</li>\n<li>\n<p>深入到封装的网络层查看<code>axios</code>返回的数据，链式函数里淘宝，分别打印了<code>response=>response.data</code>，二者数据一致错误，数据 bug 复现</p>\n</li>\n<li>\n<p>怀疑 axios 老版本不可靠，于是升级到最新版，继续测试，问题依旧</p>\n</li>\n<li>\n<p>开始 axios 请求的头部是<code>json</code>，移植之前封装的另一版本网络层代码，头部使用<code>arraybuffer</code>, 解码后<code>response</code>的数据与后台一致了，\n但是<code>response.data</code>数据仍错误，因为二者间只多了一次<code>JSON.parse</code>,定位问题在<code>JSON.parse</code></p>\n</li>\n<li>\n<p>因为 JSON.parse 本身不会有问题，再次开始怀疑 bug 源于后端，返回的 json 字符串格式不标准导致解析错误，可用解析工具可以顺利解析出 json，这里没有问题</p>\n</li>\n<li>\n<p>病急乱投医，怀疑 2 个接口同时请求有问题，于是注释第一个正常 API 的所有网络访问代码，返回结果一致，看来接口没有相关性，问题独立出现在第二个接口上</p>\n</li>\n<li>\n<p>复制 API 调试工具的返回 json，同时网络层截断发往结果异常 API 接口的所有网络访问，把复制的 json 作为固定数据返回给\n<code>response</code>，错误依旧，问题确定位在前端了</p>\n</li>\n<li>\n<p>把 10 中的 json 里的 type 属性改名为 mode，axios 解析的数据正常了</p>\n</li>\n<li>\n<p>继续看 axios 封装内容，<code>.then(response=>{...})</code>同时打印<code>response， JSON.parse(response.data)</code>, 数据又正确了，并且打印出数据一致。\n基本排除 axios 错误的可能性，那么就只剩下前端页面代码 bug 这一种可能性了，开始从网络层逐渐向应用层排查</p>\n</li>\n<li>\n<p>最后可耻的在 reducer 里发现了自己写死的代码<code>response[0].type = 2</code>, 根源找到</p>\n</li>\n</ol>\n<p><strong>总耗时： 8 小时</strong></p>\n<h4 id=\"原因\"><a href=\"#%E5%8E%9F%E5%9B%A0\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>原因</h4>\n<p>简单说就是 chrome 的 console.log 打印对象时，如果对象后续值被修改了，打印的值也会随之改变，除非打印时就立刻展开对象的所有属性</p>\n<p><code>stackoverflow</code>找到了问题，这个问题（或者说 bug）起源于 webkit 的一个 bug <a href=\"https://stackoverflow.com/questions/11284663/console-log-shows-the-changed-value-of-a-variable-before-the-value-actually-ch%5D\" target=\"_blank\" rel=\"noopener\"><code>stackoverflow问题地址</code></a></p>\n<blockquote>\n<p>Excerpts from the original bug report ([https://bugs.webkit.org/show_bug.cgi?id=35801]):</p>\n<p>Description From mitch kramer 2010-03-05 11:37:45 PST</p>\n<ol>\n<li>\n<p>create an object literal with one or more properties</p>\n</li>\n<li>\n<p>console.log that object but leave it closed (don't expand it in the console)</p>\n</li>\n<li>\n<p>change one of the properties to a new value</p>\n</li>\n</ol>\n<p>now open that console.log and you'll see it has the new value for some reason, even though it's value was different at the time it was generated.</p>\n<p>I should point out that if you open it, it will retain the correct value if that wasn't clear.</p>\n</blockquote>\n<h4 id=\"规避方法\"><a href=\"#%E8%A7%84%E9%81%BF%E6%96%B9%E6%B3%95\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>规避方法</h4>\n<ul>\n<li>创建对象的一个深拷贝，使它不受后续的影响， 比如把对象转成字符串再读取回来</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<h2 id=\"应验了一句老话，眼见也未必为实，今天体会很深\"><a href=\"#%E5%BA%94%E9%AA%8C%E4%BA%86%E4%B8%80%E5%8F%A5%E8%80%81%E8%AF%9D%EF%BC%8C%E7%9C%BC%E8%A7%81%E4%B9%9F%E6%9C%AA%E5%BF%85%E4%B8%BA%E5%AE%9E%EF%BC%8C%E4%BB%8A%E5%A4%A9%E4%BD%93%E4%BC%9A%E5%BE%88%E6%B7%B1\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>应验了一句老话，眼见也未必为实，今天体会很深</h2>\n</blockquote>","frontmatter":{"date":"May 04, 2018","title":"一次搞笑而深刻的bug调试","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABwkC0D//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABoQAAICAwAAAAAAAAAAAAAAAAERACAhMUH/2gAIAQEAAT8hQT3McFf/2gAMAwEAAgADAAAAEDDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBAAAgEFAQAAAAAAAAAAAAAAAREAECExUWFx/9oACAEBAAE/EFAwDTvCXwelxjkZSr//2Q==","aspectRatio":1.5056179775280898,"src":"/static/9983387778f1c70c0ce32374522d12c6/d7b72/post-default-bg.jpg","srcSet":"/static/9983387778f1c70c0ce32374522d12c6/2347c/post-default-bg.jpg 750w,\n/static/9983387778f1c70c0ce32374522d12c6/5a448/post-default-bg.jpg 1500w,\n/static/9983387778f1c70c0ce32374522d12c6/d7b72/post-default-bg.jpg 3000w,\n/static/9983387778f1c70c0ce32374522d12c6/439d2/post-default-bg.jpg 4288w","sizes":"(max-width: 3000px) 100vw, 3000px"}}}}}},"pageContext":{"slug":"/Blog/一次搞笑而深刻的bug调试/","previous":{"fields":{"slug":"/Blog/如何判断日期是否为今天/"},"frontmatter":{"title":"如何判断日期是否为今天"}},"next":{"fields":{"slug":"/Blog/CST与GMT的差别/"},"frontmatter":{"title":"CST与GMT的差别"}}}}