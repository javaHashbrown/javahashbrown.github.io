{"componentChunkName":"component---src-templates-post-post-js","path":"/Blog/配置Nginx和WebpackDevServer支持开发环境热更新和https域名访问/","result":{"data":{"markdownRemark":{"id":"9e5c733d-c0a1-5de8-aac8-6790c0f6b061","excerpt":"开始之前，先推荐一个工具网站 用于测试配置文件中location匹配，感觉很方便 Nginx location match tester： https://nginx.viraptor.info/ 背景 node…","html":"<p>开始之前，先推荐一个工具网站</p>\n<blockquote>\n<p>用于测试配置文件中location匹配，感觉很方便</p>\n<p>Nginx location match tester： <a href=\"https://nginx.viraptor.info/\" target=\"_blank\" rel=\"noopener\">https://nginx.viraptor.info/</a></p>\n</blockquote>\n<h3 id=\"背景\" style=\"position:relative;\"><a href=\"#%E8%83%8C%E6%99%AF\" aria-label=\"背景 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>背景</h3>\n<p>node接入层+前端，新老业务共用域名</p>\n<p>新业务通过地址前缀来区分请求</p>\n<h3 id=\"问题\" style=\"position:relative;\"><a href=\"#%E9%97%AE%E9%A2%98\" aria-label=\"问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>问题</h3>\n<p>经过配置生产环境下可以正常访问，但：</p>\n<ol>\n<li>开发模式下无法从webpack-dev-server获取静态资源</li>\n<li>无法实现dev-server热更新</li>\n</ol>\n<h3 id=\"原因\" style=\"position:relative;\"><a href=\"#%E5%8E%9F%E5%9B%A0\" aria-label=\"原因 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>原因</h3>\n<p>通过域名访问时，Nginx把新对应的业务请求转发给node</p>\n<ol>\n<li>因为开发模式下静态资源保存在webpack-dev-server里，其端口号与node监听端口不同，所以node无法找到静态资源，表现为资源请求失败</li>\n<li>\n<p>webpack-dev-server热更新是基于websocket实现的，但是：</p>\n<ul>\n<li>请求的域名不同，Nginx无法响应</li>\n<li>Nginx不能响应websocket请求，也无法响应</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"解决方案\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88\" aria-label=\"解决方案 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解决方案</h3>\n<ol>\n<li>开发模式下静态资源请求反向代理到webpack-dev-server</li>\n<li>开发模式下修改webpack配置，使其热更新websocket请求域名与业务域名相同</li>\n<li>Nginx配置websocket响应规则，反向代理到webpack-dev-server</li>\n</ol>\n<h3 id=\"具体代码\" style=\"position:relative;\"><a href=\"#%E5%85%B7%E4%BD%93%E4%BB%A3%E7%A0%81\" aria-label=\"具体代码 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>具体代码</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//webpack config 追加配置</span>\n<span class=\"token comment\">// 静态资源发布配置</span>\npublicPath<span class=\"token operator\">:</span> <span class=\"token constant\">DEV</span> <span class=\"token operator\">?</span> <span class=\"token string\">'https://www.example.com/dev'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'https://www.example.com'</span><span class=\"token punctuation\">,</span>\n<span class=\"token comment\">// webpack-dev-server配置</span>\ndevServer<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\tport<span class=\"token punctuation\">,</span>\n\thost<span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// Invalid Host/Origin Header</span>\n  disableHostCheck<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 修改web socket端口和域名，让nginx可以解析响应</span>\n  sockPort<span class=\"token operator\">:</span> <span class=\"token number\">443</span><span class=\"token punctuation\">,</span>\n  sockHost<span class=\"token operator\">:</span> <span class=\"token string\">'www.example.com'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">server\n<span class=\"token punctuation\">{</span>\n    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n\n    server_name www.example.com<span class=\"token punctuation\">;</span>\n    <span class=\"token builtin class-name\">return</span>  <span class=\"token number\">301</span> https://<span class=\"token variable\">$host</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nserver\n<span class=\"token punctuation\">{</span>\n    listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span>\n    server_name www.example.com<span class=\"token punctuation\">;</span>\n    index index.html index.htm index.php<span class=\"token punctuation\">;</span>\n    root /path/to/your/project<span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token comment\"># ssl             on;</span>\n    ssl_certificate /path/to/your/cert<span class=\"token punctuation\">;</span>\n    ssl_certificate_key /path/to/your/key<span class=\"token punctuation\">;</span>\n\n    error_log /path/to/your/error/log<span class=\"token punctuation\">;</span>\n    access_log /path/to/your/access/log combined<span class=\"token punctuation\">;</span>    \n\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$host</span> ~* ^example<span class=\"token punctuation\">\\</span>.com$<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        rewrite ^/<span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span>$ https://www.<span class=\"token variable\">$host</span><span class=\"token variable\">$request_uri</span>  permanent<span class=\"token punctuation\">;</span>\n        <span class=\"token builtin class-name\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">#生产环境，node站点静态资源请求转发到node</span>\n    location ^~ /node/assets <span class=\"token punctuation\">{</span>\n        proxy_pass http://node_proxy<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">#开发环境下静态资源反向代理到 Webpack devServer</span>\n    location ^~ /dev <span class=\"token punctuation\">{</span>\n        proxy_pass http://webpack_dev_server<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\t\t\n    location ~* <span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>css<span class=\"token operator\">|</span>js<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">{</span>\n\t    add_header Access-Control-Allow-Credentials  <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        add_header Access-Control-Allow-Origin https://www.example.com<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    \n    <span class=\"token comment\">##websocket反向代理，支持dev-server热更新</span>\n    location /sockjs-node <span class=\"token punctuation\">{</span>\n        proxy_set_header X-Real-IP  <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n        proxy_set_header X-Forwarded-For <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n        proxy_set_header Host <span class=\"token variable\">$host</span><span class=\"token punctuation\">;</span>\n        proxy_pass http://webpack_dev_server<span class=\"token punctuation\">;</span>\n        proxy_redirect off<span class=\"token punctuation\">;</span>\n      \tproxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span>\n        proxy_set_header Upgrade <span class=\"token variable\">$http_upgrade</span><span class=\"token punctuation\">;</span>\n        proxy_set_header Connection <span class=\"token string\">\"upgrade\"</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>\n\n    \n\t\t<span class=\"token comment\">#node服务</span>\n    location /node <span class=\"token punctuation\">{</span>\n        proxy_store off<span class=\"token punctuation\">;</span>\n        proxy_redirect off<span class=\"token punctuation\">;</span>\n        proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span>\n        proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n        proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span>\n        proxy_set_header X-Forwarded-Proto <span class=\"token variable\">$scheme</span><span class=\"token punctuation\">;</span>\n        proxy_set_header Remote-Host <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n        proxy_set_header X-Nginx-Proxy <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        proxy_pass http://node_proxy<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\nupstream node_proxy <span class=\"token punctuation\">{</span>\n    server <span class=\"token number\">127.0</span>.0.1:10110<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">#webpack-dev-server服务器地址</span>\nupstream webpack_dev_server <span class=\"token punctuation\">{</span>\n   server <span class=\"token number\">127.0</span>.0.1:10100<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"总结\" style=\"position:relative;\"><a href=\"#%E6%80%BB%E7%BB%93\" aria-label=\"总结 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>总结</h3>\n<h4 id=\"其他方案：webpack-dev-server代理转发到nginx\" style=\"position:relative;\"><a href=\"#%E5%85%B6%E4%BB%96%E6%96%B9%E6%A1%88%EF%BC%9Awebpack-dev-server%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91%E5%88%B0nginx\" aria-label=\"其他方案：webpack dev server代理转发到nginx permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>其他方案：webpack-dev-server代理转发到Nginx</h4>\n<p>这样在本地开发时就可以实现https访问+webpack-dev-server热更新了</p>\n<p>Done</p>","frontmatter":{"date":"January 07, 2020","title":"配置Nginx和WebpackDevServer支持开发环境热更新和https域名访问","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABwkC0D//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABoQAAICAwAAAAAAAAAAAAAAAAERACAhMUH/2gAIAQEAAT8hQT3McFf/2gAMAwEAAgADAAAAEDDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBAAAgEFAQAAAAAAAAAAAAAAAREAECExUWFx/9oACAEBAAE/EFAwDTvCXwelxjkZSr//2Q==","aspectRatio":1.5060240963855422,"src":"/static/9983387778f1c70c0ce32374522d12c6/7a34f/post-default-bg.jpg","srcSet":"/static/9983387778f1c70c0ce32374522d12c6/72227/post-default-bg.jpg 750w,\n/static/9983387778f1c70c0ce32374522d12c6/d41e0/post-default-bg.jpg 1500w,\n/static/9983387778f1c70c0ce32374522d12c6/7a34f/post-default-bg.jpg 3000w,\n/static/9983387778f1c70c0ce32374522d12c6/76224/post-default-bg.jpg 4288w","sizes":"(max-width: 3000px) 100vw, 3000px"}}}}}},"pageContext":{"slug":"/Blog/配置Nginx和WebpackDevServer支持开发环境热更新和https域名访问/","previous":{"fields":{"slug":"/Blog/mac终端中文显示数字编码的设置问题/"},"frontmatter":{"title":"mac终端中文显示数字编码的设置问题"}},"next":null}}}