{"componentChunkName":"component---src-templates-post-post-js","path":"/Blog/CDN缓存不同步: 一次线上调试的经历/","webpackCompilationHash":"9b2619a88bc10fca86fe","result":{"data":{"markdownRemark":{"id":"3ea6e06f-addc-5c6e-86eb-1b9cae9339c0","excerpt":"写在前面 这是大概3个月之前的一次线上调试过程，最后排查到的原因很简单，但调试过程让我认识了所谓“线上环境复杂”是什么意思。 背景信息 这是入职后接手的第一个H…","html":"<h3 id=\"写在前面\"><a href=\"#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2\" aria-label=\"写在前面 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>写在前面</h3>\n<p>这是大概3个月之前的一次线上调试过程，最后排查到的原因很简单，但调试过程让我认识了所谓“线上环境复杂”是什么意思。</p>\n<h3 id=\"背景信息\"><a href=\"#%E8%83%8C%E6%99%AF%E4%BF%A1%E6%81%AF\" aria-label=\"背景信息 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>背景信息</h3>\n<p>这是入职后接手的第一个H5页面需求，也是比较重要内部项目，几乎所有公司部门都参与了此项目。项目完成后获得了公司的内部奖励，当然这是后话了。</p>\n<p>我负责的部分算项目中比较简单的一块，2个web管理后台页面+5个H5前端页面。管理后台录入数据，然后H5页面拉接口展示，同时后台数据还可以被客户端直接使用。主要工作量在我的后台搭档那里，前端切图仔按设计出页面就可以了。</p>\n<p>活很简单，慢悠悠的一周就做完了，然后自测、提测。PM说需要等下游客户端开发完毕后一起发布，于是等了快3周。</p>\n<p>到了发布当天，却出现了莫名其妙的样式bug。</p>\n<h3 id=\"bug排查过程\"><a href=\"#bug%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B\" aria-label=\"bug排查过程 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>BUG排查过程</h3>\n<p>发布后搭档的手机发现有一个H5页面样式全崩了。而我手机上的显示却完全正常</p>\n<ol>\n<li>\n<p>检查发布过程</p>\n<p>gitlab里CI打包正常-->重新发布-->发现问题依旧</p>\n<p><strong>结论1：暂无</strong></p>\n</li>\n<li>\n<p>清理App缓存，再刷新页面</p>\n<p>因为App里有页面缓存，加上之前做过预发布，我这里显示正常有可能是之前的缓存。那么首先清理掉缓存，确保页面文件都是新发布的。</p>\n<p>清理后，搭档的手机显示仍然不对，我的手机显示也不对了。</p>\n<p><strong>结论2：应该是css文件有问题</strong></p>\n</li>\n<li>\n<p>PC端查看</p>\n<p>这个页面是H5和PC端共用的，所以PC端也可以查看，这样调试成本稍微低一些。</p>\n<p>首先，PC端也显示不正常-->用Chrome devtool看css文件是否有正确下载-->未见下载css文件</p>\n<p><strong>结论3：css文件没有下载</strong></p>\n</li>\n<li>\n<p>排查CI发布包文件</p>\n<p>发现发布包html文件中没有引入css文件-->发现html文件因为代码格式化引发打包程序bug，未能正确打包css文件</p>\n<p><strong>结论4：css文件没有正确打包</strong></p>\n</li>\n<li>\n<p>PC端查看，发现css文件有错误</p>\n<p>修复后重新发布，bug依然存在-->浏览器devtool在network里能看到对应的css文件-->打开css文件路径，查看css文件内容是否正确-->经过关键词搜索，发现缺失了几个样式</p>\n<p><strong>结论5：css文件有错误</strong></p>\n</li>\n<li>\n<p>下载gitlab打包文件，比对线上和发布包内的css文件</p>\n<p>发现打包的css文件和线上css文件hash不同，似乎发布未生效。</p>\n<p><strong>结论6：发布的css文件与线上css文件不同步</strong></p>\n</li>\n<li>\n<p>偶然：另一名同事发现手机显示正常</p>\n<p>另一名同事清理App缓存后显示正常-->我和搭档的手机显示仍然不对，PC端也不对</p>\n<p><strong>结论7：css文件在某些手机上正常下载？？！！！</strong></p>\n</li>\n<li>\n<p>切换为同一网络条件</p>\n<p>注意到搭档和我都连接的公司wifi，而另一名同事用的移动4G，难道是CDN缓存未同步？</p>\n<p>让另一名同事连公司wifi，清理缓存-->刷新页面，样式bug复现</p>\n<p><strong>结论8：CDN缓存不同步??</strong></p>\n</li>\n<li>\n<p>增加vConsole，比较显示为正常的css文件和有问题的css文件</p>\n<p>临时上线增加了vConsole的版本，在另一个同事手机上查看css文件版本-->正常显示的css文件hash和异常css文件hash不同-->前者和gitlab发布包内css文件hash相同，后者和上一个发布版本的css文件hash相同</p>\n<p><strong>结论9：确认CDN缓存不同步</strong></p>\n</li>\n<li>\n<p>修复上线</p>\n<p><strong>出问题的css文件做了小改动，刷新了文件hash，再次发布上线，bug立刻修复</strong></p>\n</li>\n</ol>\n<p>整个调试排查时间约3个小时</p>\n<h3 id=\"原因分析\"><a href=\"#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90\" aria-label=\"原因分析 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>原因分析</h3>\n<p>第一次bug是打包的失误，第二次bug复现应该算是典型的CDN缓存问题。</p>\n<p>因为html文件使用相同名字，覆盖发布，可能会有缓存同步延迟，而css文件名是基于hash的，每次改动后文件名不同，不存在覆盖问题。</p>\n<p>所以真正的bug源就是html页面文件没有同步，导致访问时没有请求到新版的css文件。第一次bug出现时，css文件没有下载可以理解，因为打包遗漏了，自然不会下载。但是第二次bug出现时，合理的组合应该是<code>新html+无css</code>或者<code>新html+新css</code>。</p>\n<p>为什么会出现 <code>新html+旧css</code>这样的组合，暂时没有合理的答案。因为当时着急发布，没有立即检查修复后的情况，现在已经无法还原场景了。哎。</p>\n<h3 id=\"总结\"><a href=\"#%E6%80%BB%E7%BB%93\" aria-label=\"总结 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>总结</h3>\n<p>总之失误挺多的，经验不足也导致反应不够迅速，处置手段也比较具有侵入性。比如，老司机估计最多在第4步就判断出原因了，而我这只菜鸡在第6步才意识到。第9步也完全可以省去一次发布，用4G网络开个热点通过PC端调试即可。</p>\n<p>技术进阶之路漫漫，我还要继续努力。</p>","frontmatter":{"date":"August 31, 2019","title":"CDN缓存不同步：一次线上调试的经历","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABwkC0D//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABoQAAICAwAAAAAAAAAAAAAAAAERACAhMUH/2gAIAQEAAT8hQT3McFf/2gAMAwEAAgADAAAAEDDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBAAAgEFAQAAAAAAAAAAAAAAAREAECExUWFx/9oACAEBAAE/EFAwDTvCXwelxjkZSr//2Q==","aspectRatio":1.5056179775280898,"src":"/static/9983387778f1c70c0ce32374522d12c6/9830f/post-default-bg.jpg","srcSet":"/static/9983387778f1c70c0ce32374522d12c6/1e815/post-default-bg.jpg 750w,\n/static/9983387778f1c70c0ce32374522d12c6/e7fdc/post-default-bg.jpg 1500w,\n/static/9983387778f1c70c0ce32374522d12c6/9830f/post-default-bg.jpg 3000w,\n/static/9983387778f1c70c0ce32374522d12c6/87c59/post-default-bg.jpg 4288w","sizes":"(max-width: 3000px) 100vw, 3000px"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/Blog/CDN缓存不同步: 一次线上调试的经历/","previous":{"fields":{"slug":"/Blog/2019半年小结/"},"frontmatter":{"title":"2019半年小结"}},"next":null}}}