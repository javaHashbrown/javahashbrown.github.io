{"componentChunkName":"component---src-templates-post-post-js","path":"/Blog/nginx配置的一个小错误/","result":{"data":{"markdownRemark":{"id":"69e81b10-8b03-5d35-8734-a6ef3d08a5d9","excerpt":"写在前面 最近一次帮同事找错误的经历，虽然最后发现是很低级的错误，但是过程挺有意思 问题描述 之前搭建的新管理后台项目A上线了，搭档想在本地调试，于是按照文档配好了nginx配置文件，本地启动项目，按域名访问却被重定向到了另一个项目B的页面 排查过程 检查项目A的ip…","html":"<h3 id=\"写在前面\" style=\"position:relative;\"><a href=\"#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2\" aria-label=\"写在前面 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>写在前面</h3>\n<p>最近一次帮同事找错误的经历，虽然最后发现是很低级的错误，但是过程挺有意思</p>\n<h3 id=\"问题描述\" style=\"position:relative;\"><a href=\"#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0\" aria-label=\"问题描述 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>问题描述</h3>\n<p>之前搭建的新管理后台项目A上线了，搭档想在本地调试，于是按照文档配好了nginx配置文件，本地启动项目，按域名访问却被重定向到了另一个项目B的页面</p>\n<h3 id=\"排查过程\" style=\"position:relative;\"><a href=\"#%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B\" aria-label=\"排查过程 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>排查过程</h3>\n<ol>\n<li>\n<p>检查项目A的ip地址是否正确</p>\n<p>确认是本机ip，没有错，刷新页面，问题依旧</p>\n</li>\n<li>\n<p><code>switchHosts</code>关闭其他项目的host配置，只保留项目A的配置</p>\n<p>清理dns缓存，刷新页面，问题依旧，怀疑<code>nginx</code>配置没有生效</p>\n</li>\n<li>\n<p><code>nginx -t</code> 检查配置  </p>\n<p>检查失败，报错<code>“duplicate upstream a-proxy”</code>，定位到A的<code>nginx</code>配置文件</p>\n<p><code>a-proxy</code>是配置的反向代理，在配置文件里大概是这样的</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">server {\n    ...\n    location / {\n        ...\n        proxy_pass http://a-proxy;\n    }\n}\nupstream a-proxy {\n   server 127.0.0.1: 12076;\n}</code></pre></div>\n<p>google了一下这个错误，说是出现了这个错误说明<code>a-proxy</code>出现了多次，删除多余的就可以，于是排查配置文件</p>\n</li>\n<li>\n<p>A的nginx配置文件中搜索重复的<code>a-proxy</code></p>\n<p>没有找到</p>\n</li>\n<li>\n<p>排查其他<code>server</code>的<code>nginx</code>配置文件，搜索重复的<code>a-proxy</code></p>\n<p>没有找到</p>\n</li>\n<li>\n<p>排查合并的主<code>nginx</code>配置文件，搜索重复的<code>a-proxy</code></p>\n<p>还是没有找到</p>\n</li>\n<li>\n<p>给<code>a-proxy</code>改名，看是否还是报错</p>\n<p>仍然报相同的错误，“duplicate upstream xxx-proxy”，这样基本上可以确认是A的同一份配置文件被加载了多次导致的错误</p>\n</li>\n<li>\n<p>回到主nginx配置文件，开始查找加载的配置代码  </p>\n<p>经过排查发现 <code>include servers/*</code>代码出现了多次，正是这个代码导致了同一份配置文件被多次加载。\n于是删除多余代码，重新<code>nginx -t</code>检查通过，重启nginx后项目访问正常</p>\n</li>\n</ol>\n<p><strong>总耗时： 1小时</strong></p>\n<h3 id=\"总结\" style=\"position:relative;\"><a href=\"#%E6%80%BB%E7%BB%93\" aria-label=\"总结 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>总结</h3>\n<p>经过搭档回忆，起因是之前重装nginx复制粘贴配置文件的时候不小心复制重复了一些内容。</p>\n<p>其他配置尽管重复加载，但没有遇到这个不允许重复的情况，这个问题一直没有暴露出来，直到这次...</p>\n<p>自己对nginx不太熟悉，以后还要抽时间补一补相关知识，以上。</p>","frontmatter":{"date":"October 11, 2019","title":"nginx配置的一个小错误","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABwkC0D//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABoQAAICAwAAAAAAAAAAAAAAAAERACAhMUH/2gAIAQEAAT8hQT3McFf/2gAMAwEAAgADAAAAEDDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBAAAgEFAQAAAAAAAAAAAAAAAREAECExUWFx/9oACAEBAAE/EFAwDTvCXwelxjkZSr//2Q==","aspectRatio":1.5060240963855422,"src":"/static/9983387778f1c70c0ce32374522d12c6/7a34f/post-default-bg.jpg","srcSet":"/static/9983387778f1c70c0ce32374522d12c6/72227/post-default-bg.jpg 750w,\n/static/9983387778f1c70c0ce32374522d12c6/d41e0/post-default-bg.jpg 1500w,\n/static/9983387778f1c70c0ce32374522d12c6/7a34f/post-default-bg.jpg 3000w,\n/static/9983387778f1c70c0ce32374522d12c6/76224/post-default-bg.jpg 4288w","sizes":"(max-width: 3000px) 100vw, 3000px"}}}}}},"pageContext":{"slug":"/Blog/nginx配置的一个小错误/","previous":{"fields":{"slug":"/Blog/部署node管理后台遇到的一个问题/"},"frontmatter":{"title":"部署node管理后台遇到的几个问题"}},"next":{"fields":{"slug":"/Blog/HTML中自闭合Vue组件的bug/"},"frontmatter":{"title":"HTML中自闭合Vue组件的bug"}}}}}