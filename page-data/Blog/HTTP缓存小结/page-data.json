{"componentChunkName":"component---src-templates-post-post-js","path":"/Blog/HTTP缓存小结/","result":{"data":{"markdownRemark":{"id":"7c460279-2a30-572b-8a20-49b67e336392","excerpt":"常见相关HTTP Header HTTP 1.0 Pragma 与HTTP 1.1 Cache-Control对等，为了兼容而存在； 如果Cache-Control同时存在，Pragma会被忽略； 通常设置为Pragma: no-cache; HTTP 1.1 Cache…","html":"<h3 id=\"常见相关http-header\" style=\"position:relative;\"><a href=\"#%E5%B8%B8%E8%A7%81%E7%9B%B8%E5%85%B3http-header\" aria-label=\"常见相关http header permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>常见相关HTTP Header</h3>\n<h4 id=\"http-10\" style=\"position:relative;\"><a href=\"#http-10\" aria-label=\"http 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HTTP 1.0</h4>\n<ul>\n<li><code>Pragma</code><br>\n与HTTP 1.1 <code>Cache-Control</code>对等，为了兼容而存在；<br>\n如果<code>Cache-Control</code>同时存在，Pragma会被忽略；<br>\n通常设置为<code>Pragma: no-cache</code>;</li>\n</ul>\n<h4 id=\"http-11-cache-control\" style=\"position:relative;\"><a href=\"#http-11-cache-control\" aria-label=\"http 11 cache control permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HTTP 1.1 Cache-Control</h4>\n<p>HTTP 1.1引入请求头，用于控制缓存策略  </p>\n<table>\n<thead>\n<tr>\n<th align=\"right\">HTTP header</th>\n<th align=\"left\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"right\"><code>public</code></td>\n<td align=\"left\">都可以缓存</td>\n</tr>\n<tr>\n<td align=\"right\"><code>private</code></td>\n<td align=\"left\">必须保存在私有缓存中，不可保存在共享缓存，即不可保存在CDN节点</td>\n</tr>\n<tr>\n<td align=\"right\"><code>no-cache</code></td>\n<td align=\"left\">保存缓存文件到磁盘，但未与源服务器验证前，不可使用</td>\n</tr>\n<tr>\n<td align=\"right\"><code>no-store</code></td>\n<td align=\"left\">1.不保存缓存文件到磁盘，但可以保存到内存中，转发后会尽快删除；<br>2. 无法保证私密性；</td>\n</tr>\n<tr>\n<td align=\"right\"><code>must-revalidate</code></td>\n<td align=\"left\">仅针对过期缓存，在未与源服务器验证前，不可使用</td>\n</tr>\n<tr>\n<td align=\"right\"><code>max-stale</code></td>\n<td align=\"left\">1. 请求头，表示愿意接受设置的过期时间内的缓存；<br>2. <code>max-stale: 60</code>表示过期60秒内的缓存，客户端也可以接受</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p><strong>注意<code>must-revalidate</code>与<code>no-cache</code>差别</strong>  </p>\n<ul>\n<li>前者只要求验证已过期缓存</li>\n<li>后者不论缓存是否过期都需要验证；</li>\n</ul>\n</blockquote>\n<h3 id=\"缓存类别\" style=\"position:relative;\"><a href=\"#%E7%BC%93%E5%AD%98%E7%B1%BB%E5%88%AB\" aria-label=\"缓存类别 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>缓存类别</h3>\n<h4 id=\"强缓存\" style=\"position:relative;\"><a href=\"#%E5%BC%BA%E7%BC%93%E5%AD%98\" aria-label=\"强缓存 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>强缓存</h4>\n<table>\n<thead>\n<tr>\n<th align=\"right\">HTTP header</th>\n<th align=\"center\">所属标准</th>\n<th align=\"left\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"right\"><code>Expires</code></td>\n<td align=\"center\">HTTP 1.0</td>\n<td align=\"left\">1.HTTP日期时间戳<br>2. 优先级低于<code>Cache-Control: max-age</code>，如果后者出现<code>Expires</code>将被忽略<br>3.客户端本地时间会影响时间判定<br>4. 如果解析时间错误或时间格式错误，缓存将被认为已过期</td>\n</tr>\n<tr>\n<td align=\"right\"><code>Cache-Control: max-age</code></td>\n<td align=\"center\">HTTP 1.1</td>\n<td align=\"left\">1.表示缓存最大有效期，单位是秒<br>2.优先级高于<code>Expires</code></td>\n</tr>\n<tr>\n<td align=\"right\"><code>Cache-Control: s-maxage</code></td>\n<td align=\"center\">HTTP 1.1</td>\n<td align=\"left\">1.和<code>max-age</code>类似，但用于控制共享缓存，即CDN的最大缓存有效期<br>2.优先级高于<code>max-age</code>和<code>Expires</code></td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>强缓存命中，返回HTTP状态码200</p>\n</blockquote>\n<h4 id=\"协商缓存\" style=\"position:relative;\"><a href=\"#%E5%8D%8F%E5%95%86%E7%BC%93%E5%AD%98\" aria-label=\"协商缓存 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>协商缓存</h4>\n<table>\n<thead>\n<tr>\n<th align=\"right\">HTTP header</th>\n<th align=\"center\">所属标准</th>\n<th align=\"left\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"right\">请求头：<code>If-Modified-since</code><br>响应头：<code>Last-Modified</code></td>\n<td align=\"center\">HTTP 1.0</td>\n<td align=\"left\">1.HTTP日期时间戳<br>2. 优先级低于<code>Etag</code>，如果后者出现将被忽略<br>3.只能精确到秒，速度快于1秒的变化无法感知<br>4. 连续变化但最后内容未变，会导致频繁刷新更新时间，导致之前的缓存失效</td>\n</tr>\n<tr>\n<td align=\"right\">请求头: <code>If-None-Match</code><br>响应头: <code>Etag</code></td>\n<td align=\"center\">HTTP 1.1</td>\n<td align=\"left\">1.表示文件指纹，变化只与文件内容有关<br>2.优先级高于<code>Last-Modified</code><br>3.Etag生成与具体算法有关，分布式系统中每台机器可能会为相同文件生成不同的Etag，需要统一计算规则</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>协商缓存命中返回HTTP状态码304，未命中会重新请求，成功返回200</p>\n</blockquote>\n<h3 id=\"使用场景\" style=\"position:relative;\"><a href=\"#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF\" aria-label=\"使用场景 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使用场景</h3>\n<h4 id=\"静态文件\" style=\"position:relative;\"><a href=\"#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6\" aria-label=\"静态文件 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>静态文件</h4>\n<p>变化较少的静态资源文件，如图片，或变化频繁但每个版本相对独立的静态资源文件，如js,css文件，尽量强缓存，并设置长有效期，通过hash或者类似方法区分不同文件版本，可以减少资源请求</p>\n<h4 id=\"html文件\" style=\"position:relative;\"><a href=\"#html%E6%96%87%E4%BB%B6\" aria-label=\"html文件 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>html文件</h4>\n<p>一般设置为<code>Cache-Control: no-cache</code>，要求每次回源验证，以确保每次用户访问到的都是最新版本的App；但并不绝对，有些时效性没那么强的内容，或者内容相对稳定、或者需要通过缓存减少服务器访问压力的场景，也可以结合使用<code>Cache-Control: max-age=xxx</code>  </p>\n<ul>\n<li>前者例子见参考文献3</li>\n<li>后者例子可见各类新闻网站，常见设置为<code>max-age=60</code><br>\n因为新闻内容相对稳定，设置强缓存影响css和js文件的更新，并不影响内容阅读，用户感知不明显，且此设置有助于减少服务器访问压力</li>\n<li>\n<p>缺点：结合<code>max-age</code>的网站，通常会有多个版本同时运行在线上，比较难以定位线上问题</p>\n<h3 id=\"参考文献\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" aria-label=\"参考文献 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考文献</h3>\n<p>[1] <a href=\"https://tools.ietf.org/html/rfc7234\" target=\"_blank\" rel=\"noopener\">RFC 7324</a><br>\n[2] <a href=\"https://tools.ietf.org/html/rfc7232\" target=\"_blank\" rel=\"noopener\">RFC 7232</a><br>\n[3] <a href=\"https://jakearchibald.com/2016/caching-best-practices/\" target=\"_blank\" rel=\"noopener\">Jake·Archibald: caching-best-practices</a></p>\n</li>\n</ul>","frontmatter":{"date":"February 25, 2020","title":"HTTP缓存小结","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABwkC0D//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABoQAAICAwAAAAAAAAAAAAAAAAERACAhMUH/2gAIAQEAAT8hQT3McFf/2gAMAwEAAgADAAAAEDDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBAAAgEFAQAAAAAAAAAAAAAAAREAECExUWFx/9oACAEBAAE/EFAwDTvCXwelxjkZSr//2Q==","aspectRatio":1.5060240963855422,"src":"/static/9983387778f1c70c0ce32374522d12c6/7a34f/post-default-bg.jpg","srcSet":"/static/9983387778f1c70c0ce32374522d12c6/72227/post-default-bg.jpg 750w,\n/static/9983387778f1c70c0ce32374522d12c6/d41e0/post-default-bg.jpg 1500w,\n/static/9983387778f1c70c0ce32374522d12c6/7a34f/post-default-bg.jpg 3000w,\n/static/9983387778f1c70c0ce32374522d12c6/76224/post-default-bg.jpg 4288w","sizes":"(max-width: 3000px) 100vw, 3000px"}}}}}},"pageContext":{"slug":"/Blog/HTTP缓存小结/","previous":{"fields":{"slug":"/Blog/XMLHttpRequest回顾/"},"frontmatter":{"title":"XMLHttpRequest回顾"}},"next":{"fields":{"slug":"/Blog/HTTP2.0初步/"},"frontmatter":{"title":"HTTP/2初步"}}}}}