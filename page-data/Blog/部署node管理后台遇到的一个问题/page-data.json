{"componentChunkName":"component---src-templates-post-post-js","path":"/Blog/部署node管理后台遇到的一个问题/","webpackCompilationHash":"9b2619a88bc10fca86fe","result":{"data":{"markdownRemark":{"id":"d84fb9de-82ae-58a8-961e-b3a766db3a00","excerpt":"写在前面 核心服务扩容，之前预定分配给node管理后台用的服务器不能用了。 不得不重新申请了一台服务器部署，结果部署成功后业务一直运行不起来，花了3天才排查到原因，真是尴尬。 这里记录一下，留作备忘。 背景信息 开始安装又卸载node…","html":"<h3 id=\"写在前面\"><a href=\"#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2\" aria-label=\"写在前面 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>写在前面</h3>\n<p>核心服务扩容，之前预定分配给node管理后台用的服务器不能用了。</p>\n<p>不得不重新申请了一台服务器部署，结果部署成功后业务一直运行不起来，花了3天才排查到原因，真是尴尬。</p>\n<p>这里记录一下，留作备忘。</p>\n<h3 id=\"背景信息\"><a href=\"#%E8%83%8C%E6%99%AF%E4%BF%A1%E6%81%AF\" aria-label=\"背景信息 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>背景信息</h3>\n<p>开始安装又卸载node的操作直接导致了后续业务运行失败，当然这是后话了</p>\n<p>部署流程： 申请服务器 -> 配置CI和发布系统 -> 服务器安装node10 -> 兼容性考虑卸载node10 -> 安装node7 -> 发布业务</p>\n<h3 id=\"问题一：-ci打包文件过期，发布失败\"><a href=\"#%E9%97%AE%E9%A2%98%E4%B8%80%EF%BC%9A-ci%E6%89%93%E5%8C%85%E6%96%87%E4%BB%B6%E8%BF%87%E6%9C%9F%EF%BC%8C%E5%8F%91%E5%B8%83%E5%A4%B1%E8%B4%A5\" aria-label=\"问题一： ci打包文件过期，发布失败 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>问题一： CI打包文件过期，发布失败</h3>\n<p>进入发布系统配置gitlab的发布分支，本以为这样就ok了，结果居然发布失败 - -！</p>\n<p>查发布日志发现<code>Request failed with status code 404</code></p>\n<h4 id=\"排查过程\"><a href=\"#%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B\" aria-label=\"排查过程 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>排查过程</h4>\n<ol>\n<li>查看gitlab-ci，执行正常</li>\n<li>重新打包，再次发布，继续报404</li>\n<li>下载gitlab-ci的文件，查看内容ok</li>\n<li>场外求助大佬，结果大佬查了一下jobs，告诉我因为过期，artifacts被移除了，所以发布失败...</li>\n</ol>\n<blockquote>\n<p>// 菜鸡和大佬的对话</p>\n<p>大佬： 这个job id对应的artifacts被移除了，应该过期了<br>\n菜鸡： 为什么再次打包生成了artifacts，发布还是失败呢？明明可以从gitlab里下载到最新打包的artifacts<br>\n大佬： 因为gitlab的API不保证多次打包取最新结果，它只是按job id取artifacts<br>\n大佬： 重新提交一次，重新生成一个commit id就可以了<br>\n菜鸡： （似懂非懂）谢谢大佬！  </p>\n</blockquote>\n<h4 id=\"解决方案\"><a href=\"#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88\" aria-label=\"解决方案 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解决方案</h4>\n<ol>\n<li>重新提交，刷新commit id，重新ci打包</li>\n<li>再次发布成功</li>\n</ol>\n<h4 id=\"原因分析\"><a href=\"#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90\" aria-label=\"原因分析 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>原因分析</h4>\n<p>再次问了大佬之后，终于弄明白了原因。<br>\ngitlab只能通过API下载artifacts，而不是保存在固定文件路径里。所以公司自己弄了一个组件，通过拼接参数获得artifacts的下载地址，规则如下： </p>\n<ol>\n<li>\n<p>根据commit ID取最新的Pipeline ID</p>\n<blockquote>\n<h3 id=\"api---get-a-single-commit\"><a href=\"#api---get-a-single-commit\" aria-label=\"api   get a single commit permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>API - <a href=\"https://docs.gitlab.com/ee/api/commits.html#get-a-single-commit\" target=\"_blank\" rel=\"noopener\">Get a single commit</a></h3>\n<p>Get a specific commit identified by the commit hash or name of a branch or tag.  </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GET /projects/:id/repository/commits/:sha</code></pre></div>\n<p>返回的字段中的last_pipeline就是最新的pipeline id</p>\n</blockquote>\n</li>\n<li>\n<p>根据最新的Pipeline ID取第一个成功的Job ID</p>\n<blockquote>\n<h3 id=\"api---list-pipeline-jobs\"><a href=\"#api---list-pipeline-jobs\" aria-label=\"api   list pipeline jobs permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>API - <a href=\"https://docs.gitlab.com/ee/api/jobs.html#list-pipeline-jobs\" target=\"_blank\" rel=\"noopener\">List pipeline jobs</a></h3>\n<p>Get a list of jobs for a pipeline.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GET /projects/:id/pipelines/:pipeline_id/jobs</code></pre></div>\n<p>返回一个数组，根据status字段过滤掉执行失败Jobs，然后再取response[0]就是第一个成功的Job</p>\n</blockquote>\n</li>\n<li>\n<p>根据Job ID下载对应的artifacts</p>\n<blockquote>\n<h3 id=\"api---download-a-single-artifact-file-by-job-id\"><a href=\"#api---download-a-single-artifact-file-by-job-id\" aria-label=\"api   download a single artifact file by job id permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>API - <a href=\"https://docs.gitlab.com/ee/api/jobs.html#download-a-single-artifact-file-by-job-id\" target=\"_blank\" rel=\"noopener\">Download a single artifact file by job ID</a></h3>\n<p>Download a single artifact file from a job with a specified ID from within the job’s artifacts zipped archive. The file is extracted from the archive and streamed to the client.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GET /projects/:id/jobs/:job_id/artifacts/*artifact_path</code></pre></div>\n<p>返回要下载的artifacts文件流</p>\n</blockquote>\n</li>\n</ol>\n<p><strong>结论</strong>: 当有多次打包的时候，因为pipeline id不会变化，只要之前有成功的jobs生成artifacts，那么按照上面的规则，artifacts下载API就会指向它。当artifacts过期被清除后，自然就无法找到文件了，因此接口状态返回404失败，如下表所示:</p>\n<blockquote>\n<h3 id=\"api---download-a-single-artifact-file-by-job-id-接口返回状态码\"><a href=\"#api---download-a-single-artifact-file-by-job-id-%E6%8E%A5%E5%8F%A3%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81%E7%A0%81\" aria-label=\"api   download a single artifact file by job id 接口返回状态码 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>API - <a href=\"https://docs.gitlab.com/ee/api/jobs.html#download-a-single-artifact-file-by-job-id\" target=\"_blank\" rel=\"noopener\">Download a single artifact file by job ID</a> 接口返回状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Status</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200</td>\n<td>Sends a single artifact file</td>\n</tr>\n<tr>\n<td>400</td>\n<td>Invalid path provided</td>\n</tr>\n<tr>\n<td>404</td>\n<td>Build not found or no file/artifacts</td>\n</tr>\n</tbody>\n</table>\n</blockquote>\n<h3 id=\"问题二：忘记配置线上数据库\"><a href=\"#%E9%97%AE%E9%A2%98%E4%BA%8C%EF%BC%9A%E5%BF%98%E8%AE%B0%E9%85%8D%E7%BD%AE%E7%BA%BF%E4%B8%8A%E6%95%B0%E6%8D%AE%E5%BA%93\" aria-label=\"问题二：忘记配置线上数据库 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>问题二：忘记配置线上数据库</h3>\n<blockquote>\n<p>这个实在是有点尴尬，但是部署的时候真的忘记了配置线上数据库</p>\n</blockquote>\n<p>发布成功后打开线上地址，发现迎接我的是nginx欢迎页，当时就知道完蛋了</p>\n<h4 id=\"排查过程-1\"><a href=\"#%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B-1\" aria-label=\"排查过程 1 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>排查过程</h4>\n<ol>\n<li>登陆服务器，<code>pm2 list</code>，发现所有node进程状态都是<code>errored</code></li>\n<li><code>pm2 show app_name</code>，查pm2的out和error日志</li>\n<li>发现<code>error log</code>里一堆 <code>Cannot read property 'models' of undefined</code></li>\n<li>然后排查数据库相关的所有文件，发现没配置线上数据库- -</li>\n<li>因为数据库没配置，数据库对象为undefined，然后脚本自动生成的数据库表对象统统变成了 <code>property of undefined</code>，自然无法运行。</li>\n</ol>\n<h4 id=\"解决方案-1\"><a href=\"#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1\" aria-label=\"解决方案 1 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解决方案</h4>\n<p>配置好线上数据库，然后再次发布，错误消失，终于看到业务界面了</p>\n<h3 id=\"问题三：多个pm2守护进程互相干扰\"><a href=\"#%E9%97%AE%E9%A2%98%E4%B8%89%EF%BC%9A%E5%A4%9A%E4%B8%AApm2%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E4%BA%92%E7%9B%B8%E5%B9%B2%E6%89%B0\" aria-label=\"问题三：多个pm2守护进程互相干扰 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>问题三：多个PM2守护进程互相干扰</h3>\n<p>进入业务界面后，发现首页列表接口一直报错，提示<code>api request error. Request failed with status code 403</code></p>\n<p>403显然是没有权限，这个错误消息看的我一脸懵逼...</p>\n<h4 id=\"排查过程-2\"><a href=\"#%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B-2\" aria-label=\"排查过程 2 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>排查过程</h4>\n<ol>\n<li>\n<p>错误消息显然不是我包装的，那只能来自其他地方</p>\n<p>因为列表请求分为2个步骤，第一步取数据库数据，第二步请求接口服务的数据，所以最可能的地方有2个：一是数据库请求报错了；二是列表接口调用的公司接口服务报错了</p>\n</li>\n<li>\n<p>排查数据库错误</p>\n<p>进一步试验发现不仅列表接口报错，新建接口也报了同样的错误。</p>\n<ul>\n<li>难以确定是否是数据库错误的情况下，查了数据库的数据，发现尽管新建接口报错，但是新建的数据都已经写入了数据库，似乎与数据库没关系</li>\n<li>登陆服务器，继续排查列表接口，数据库请求操作那里打印数据，重启业务应用<code>pm2 restart app_name</code>，再次请求后查看日志，发现数据库请求能正常返回数据，基本排除数据库错误</li>\n</ul>\n</li>\n<li>\n<p>排查接口服务错误</p>\n<p>既然数据库错误可以排除，那么自然开始排查接口服务错误</p>\n<ul>\n<li>在接口服务请求前后打印日志，做个标记，看看是否请求会报错，以及如果请求成功会返回什么数据</li>\n<li>重启业务应用，再次请求接口后查看日志，发现日志只有接口服务请求前的输出，然后就报错了</li>\n<li>基本上可以确定是请求接口服务导致的错误</li>\n</ul>\n</li>\n<li>\n<p>接口服务大佬帮忙看日志</p>\n<p>到这一步我已经没什么办法了，只能跪求负责接口服务的大佬帮我看一下他那边的日志。</p>\n<blockquote>\n<p> 这个接口服务是需要授权的，线上和测试环境都有独立的授权key，通过key+请求时间，应该就可以找到原因</p>\n</blockquote>\n<p>结果接口服务的日志里根本没有业务应用的任何请求，我当时的内心是崩溃的...</p>\n<ul>\n<li>大佬继续帮忙排查授权key，没发现问题</li>\n<li>排查接口服务初始化的代码，没发现问题</li>\n<li>排查传入接口服务的参数，没发现问题</li>\n<li>大佬上服务器直接用node调用代码请求接口服务，居然好了，可以获取数据，同时接口服务的日志也记录到了这个请求</li>\n</ul>\n<p>到这里，接口服务肯定是正常的，我的代码应该也是正常的，基本上只能是业务应用部署环境的原因了</p>\n</li>\n<li>\n<p>停止pm2，裸跑node</p>\n<p>考虑到大佬直接用node调用代码请求是成功的，我也照猫画虎，先停掉所有pm2的服务<code>pm2 stop app_name</code>，然后用node启动业务应用<code>NODE_ENV=production node app_server.js</code></p>\n<p>见证奇迹的时刻到了，这样启动的业务完全正常，没有报任何错误，那么可以肯定问题来自于pm2了，下面继续排查</p>\n</li>\n<li>\n<p>起动单进程pm2</p>\n<p>为了排除pm2多进程间互相影响的可能性，我修改了pm2生产环境的配置文件，把它的进程数限制为1。</p>\n<p>然后就是套路操作，为了避免缓存影响，先停止服务，再删除当前应用，最后重新启动应用。</p>\n<p>访问应用页面，依然报错...我又崩溃了</p>\n<p>不过这一步再次确认了pm2就是问题根源，继续排查</p>\n</li>\n<li>\n<p>终于排查到错误</p>\n<p>经过大佬提示，查看了pm2相关的所有进程<code>ps aux | grep pm2</code>，发现居然有2个<code>pm2 God Daemon</code>守护进程</p>\n<p>大佬说很有可能问题就在这里了。</p>\n</li>\n</ol>\n<h4 id=\"解决方案-2\"><a href=\"#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2\" aria-label=\"解决方案 2 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解决方案</h4>\n<p>杀掉多余的pm2 God Daemon守护进程，重启pm2服务，再次访问，终于不报错了...</p>\n<h4 id=\"原因分析-1\"><a href=\"#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90-1\" aria-label=\"原因分析 1 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>原因分析</h4>\n<p>都是最开始安装再卸载node10的锅。</p>\n<p>咨询了运维大佬，告诉我服务器安装node的时候会安装nodejs，pm2和pm2-logrotate日志切片服务，<strong>卸载的时候会直接卸载nodejs服务，同时删除pm2的目录，但好像不会杀掉pm2的进程</strong></p>\n<p>所以安装node7的时候，前一个pm2的进程还在运行，安装完成后2个pm2进程互相干扰。细节就不清楚了，反正对接口服务的请求在这样的情况下根本就没发出去。哎...</p>\n<p><strong>总耗时：断断续续花了3天</strong></p>\n<h3 id=\"反馈运维：bug重现试验\"><a href=\"#%E5%8F%8D%E9%A6%88%E8%BF%90%E7%BB%B4%EF%BC%9Abug%E9%87%8D%E7%8E%B0%E8%AF%95%E9%AA%8C\" aria-label=\"反馈运维：bug重现试验 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>反馈运维：bug重现试验</h3>\n<p>为了得到确切的结论：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">- 服务器卸载时是否会杀掉pm2进程\n- 遗漏杀掉前一个pm2进程，而直接安装新的node是否导致了问题三的bug</code></pre></div>\n<p>和运维大佬沟通了一下，决定试试能否重现bug，这样运维大佬可以有针对性的更改部署脚本，避免下次还有人跟我踩一样的坑。</p>\n<p>一共做了2次试验，第一次是为了复现bug，第二次是为了排除bug，确定具体bug源究竟在哪里。</p>\n<ol>\n<li>第一次：复原bug过程</li>\n<li>准备工作：停止pm2服务，杀掉所有pm2关联进程，卸载node及相关组件服务</li>\n<li>恢复初始状态：安装node10 -> 卸载node10 -> 安装node7(可能需要运维介入) -> 发布业务</li>\n<li>查看是否复现bug</li>\n<li>第二次：消除bug，一次性顺利安装</li>\n<li>准备工作： 在第一次的基础上，停止pm2服务，杀掉所有pm2关联进程，卸载node及相关组件服务</li>\n<li>安装node10</li>\n<li>停止所有pm2相关服务，杀掉pm2关联进程，卸载node10</li>\n<li>安装node7</li>\n<li>发布业务，观察是否顺利部署</li>\n</ol>\n<p><strong>未完待续...</strong></p>","frontmatter":{"date":"October 10, 2019","title":"部署node管理后台遇到的几个问题","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABwkC0D//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABoQAAICAwAAAAAAAAAAAAAAAAERACAhMUH/2gAIAQEAAT8hQT3McFf/2gAMAwEAAgADAAAAEDDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBAAAgEFAQAAAAAAAAAAAAAAAREAECExUWFx/9oACAEBAAE/EFAwDTvCXwelxjkZSr//2Q==","aspectRatio":1.5056179775280898,"src":"/static/9983387778f1c70c0ce32374522d12c6/9830f/post-default-bg.jpg","srcSet":"/static/9983387778f1c70c0ce32374522d12c6/1e815/post-default-bg.jpg 750w,\n/static/9983387778f1c70c0ce32374522d12c6/e7fdc/post-default-bg.jpg 1500w,\n/static/9983387778f1c70c0ce32374522d12c6/9830f/post-default-bg.jpg 3000w,\n/static/9983387778f1c70c0ce32374522d12c6/87c59/post-default-bg.jpg 4288w","sizes":"(max-width: 3000px) 100vw, 3000px"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/Blog/部署node管理后台遇到的一个问题/","previous":{"fields":{"slug":"/Blog/前端二年/"},"frontmatter":{"title":"前端二年"}},"next":{"fields":{"slug":"/Blog/nginx配置的一个小错误/"},"frontmatter":{"title":"nginx配置的一个小错误"}}}}}